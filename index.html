<script>
const ROOT = "https://raw.githubusercontent.com/Flo-App-bxl/TDID-Live/main/";
const DEPOTS = ["brel","delta","erasme"];
const ERR_IMG = ROOT + "TDID_Erreur.png";
const REFRESH_MS = 3000, STALE_MS = 120000;

const img   = document.getElementById('view');
const note  = document.getElementById('note');
const stamp = document.getElementById('stamp');

let depot = localStorage.getItem('tdid_depot') || 'brel';
for (const d of DEPOTS){
  const el = document.getElementById(d);
  el.onclick = ()=>{ depot=d; localStorage.setItem('tdid_depot',depot); setActive(); tick(true); };
}
function setActive(){ for (const d of DEPOTS) document.getElementById(d).classList.toggle('active', d===depot); }
setActive();

async function fetchNoCache(u){ return fetch(u+"?t="+Date.now(),{cache:"no-store"}); }
async function fetchJSON(u){ const r=await fetchNoCache(u); if(!r.ok) throw new Error("HTTP "+r.status); return {json: await r.json(), date:r.headers.get('Date')}; }
async function fetchTEXT(u){ const r=await fetchNoCache(u); if(!r.ok) throw new Error("HTTP "+r.status); return {text: await r.text(), date:r.headers.get('Date')}; }
async function fetchBLOBURL(u){ const r=await fetchNoCache(u); if(!r.ok) throw new Error("HTTP "+r.status); return URL.createObjectURL(await r.blob()); }

function tzOffsetMs(){ return new Date().getTimezoneOffset()*60000; }

/* Normalise un epoch :
   - Si déjà en ms UTC → renvoie tel quel.
   - Si "dans le futur" mais |delta| < 12h → suppose epoch local et convertit en UTC (= age - offset) */
function normalizeEpoch(msRaw, nowRef){
  let ms = Number(msRaw);
  if (!Number.isFinite(ms)) return null;
  if (ms < 1e12) ms *= 1000; // secondes → ms

  const delta = ms - nowRef;  // >0 = futur
  if (delta > 0 && delta < 12*3600*1000){
    // Probable "heure locale" encodée comme UTC
    ms = ms - tzOffsetMs();
  }
  return ms;
}

async function tick(force=false){
  setActive();
  let diag = `Depot: ${depot}\n`;

  // 1) MANIFEST
  try{
    const {json:man, date} = await fetchJSON(ROOT + `live_${depot}.json`);
    const serverNow = date ? new Date(date).getTime() : Date.now();
    const age = normalizeEpoch(man.age, serverNow);
    if (age===null) throw new Error("age invalide");

    const dSec = Math.round((serverNow - age)/1000);
    diag += `age(manifest) • Δ=${dSec>=0?"+":""}${dSec}s → ${dSec>=120?"STALE":"OK"}`;
    if (dSec*1000 >= STALE_MS){
      img.src = ERR_IMG;
      stamp.textContent = "Hors service (≥2 min) • " + new Date().toLocaleString();
      note.textContent = diag + "\n→ Affichage Erreur";
      return;
    }
    // image versionnée => pas de cache
    const blobUrl = await fetchBLOBURL(ROOT + String(man.png||""));
    img.onload  = ()=>{ stamp.textContent = new Date().toLocaleString(); };
    img.onerror = ()=>{ stamp.textContent = "Erreur de chargement • " + new Date().toLocaleString(); };
    img.src = blobUrl;
    note.textContent = diag;
    return;
  }catch(e){
    diag += `manifest KO (${e.message}) → fallback legacy`;
  }

  // 2) LEGACY
  try{
    const {text:ageTxt, date} = await fetchTEXT(ROOT + `live_${depot}.age.txt`);
    const serverNow = date ? new Date(date).getTime() : Date.now();
    const age = normalizeEpoch(ageTxt.trim(), serverNow);
    if (age===null) throw new Error("age invalide");
    const dSec = Math.round((serverNow - age)/1000);
    diag += `\nage.txt • Δ=${dSec>=0?"+":""}${dSec}s → ${dSec>=120?"STALE":"OK"}`;
    if (dSec*1000 >= STALE_MS){
      img.src = ERR_IMG;
      stamp.textContent = "Hors service (≥2 min) • " + new Date().toLocaleString();
      note.textContent = diag + "\n→ Affichage Erreur";
      return;
    }
    const blobUrl = await fetchBLOBURL(ROOT + `live_${depot}.png`);
    img.onload  = ()=>{ stamp.textContent = new Date().toLocaleString(); };
    img.onerror = ()=>{ stamp.textContent = "Erreur de chargement • " + new Date().toLocaleString(); };
    img.src = blobUrl;
    note.textContent = diag;
  }catch(e2){
    diag += `\nlegacy KO (${e2.message}) → Erreur`;
    img.src = ERR_IMG;
    note.textContent = diag;
  }
}

setInterval(()=>tick(false), REFRESH_MS);
tick(true);
</script>
