<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>TDID - Train and Departure Information for Driver</title>
  <style>
    :root{--bg:#0f1115;--fg:#eaeef5;--card:#141923;--line:#1e2330;--accent:#1a5bff;}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    body{padding-top:64px;}
    .top{position:fixed;top:0;left:0;right:0;height:64px;display:flex;gap:8px;align-items:center;padding:10px 12px;background:#12151b90;border-bottom:1px solid var(--line);backdrop-filter:blur(6px);z-index:10}
    .btn{padding:8px 14px;border:1px solid var(--line);border-radius:12px;background:var(--card);color:var(--fg);cursor:pointer}
    .btn.active{background:var(--accent);color:#fff;border-color:transparent}
    .wrap{height:calc(100vh - 64px);display:flex;align-items:center;justify-content:center}
    img{max-width:100%;max-height:100%;object-fit:contain}
    .stamp{margin-left:auto;opacity:.8;font-size:.9em}
    .note{position:fixed;bottom:8px;left:50%;transform:translateX(-50%);opacity:.85;font-size:.85em;text-align:center;white-space:pre-line;transform:translateX(-50%)}
  </style>
</head>
<body>
  <div class="top">
    <strong>TDID Live</strong>
    <button class="btn" id="brel">Brel</button>
    <button class="btn" id="delta">Delta</button>
    <button class="btn" id="erasme">Erasm.</button>
    <span class="stamp" id="stamp">—</span>
  </div>
  <div class="wrap"><img id="view" alt="TDID Live"></div>
  <div class="note" id="note"></div>

<script>
const URLS = {
  brel:  { img: "./live_brel.png",  age: "./live_brel.age.txt"  },
  delta: { img: "./live_delta.png", age: "./live_delta.age.txt" },
  erasme:{ img: "./live_erasme.png",age: "./live_erasme.age.txt"}
};
const ERR_IMG = "./TDID_Erreur.png";
const REFRESH_MS = 3000;
const STALE_MS   = 120000;

const img = document.getElementById('view');
const stamp = document.getElementById('stamp');
const note = document.getElementById('note');
const btns = { brel:document.getElementById('brel'), delta:document.getElementById('delta'), erasme:document.getElementById('erasme') };

let depot = localStorage.getItem('tdid_depot') || 'brel';
let lastOk = 0;

function setActive(){ for (const k in btns) btns[k].classList.toggle('active', k===depot); }
for (const k in btns){ btns[k].onclick = ()=>{ depot=k; localStorage.setItem('tdid_depot', depot); setActive(); tick(true); }; }
setActive();

const cb = u => u + (u.includes('?')?'&':'?') + 't=' + Date.now();

async function readAge(url){
  try{
    const r = await fetch(cb(url), {cache:'no-store'});
    if(!r.ok) throw 0;
    const ms = parseInt((await r.text()).trim(),10);
    return Number.isFinite(ms) ? ms : null;
  }catch{ return null; }
}

function loadOnce(src){
  return new Promise(resolve=>{
    img.onload = ()=>{ lastOk = Date.now(); stamp.textContent = new Date().toLocaleString(); resolve(true); };
    img.onerror= ()=>{ stamp.textContent = "Erreur de chargement • " + new Date().toLocaleString(); resolve(false); };
    img.src = cb(src);
  });
}

async function tick(force=false){
  const u = URLS[depot];
  let line = "Mode : GitHub Pages (même origine)";
  const ms = await readAge(u.age);
  if (ms !== null){
    const delta = Date.now() - ms;
    line += "\nΔ="+Math.round(delta/1000)+"s";
    if (delta >= STALE_MS){
      img.src = ERR_IMG;
      stamp.textContent = "Hors service (≥2 min) • " + new Date().toLocaleString();
      note.textContent = line + "\n→ Affichage Erreur";
      return;
    }
  } else {
    line += "\nÂge indisponible — suivi par rechargement";
  }
  const ok = await loadOnce(u.img);
  if (!ok && (force || (lastOk>0 && Date.now()-lastOk >= STALE_MS))){
    img.src = ERR_IMG;
    line += "\nImage indisponible → Erreur";
  }
  note.textContent = line;
}

setInterval(()=>tick(false), REFRESH_MS);
tick(true);
</script>
</body>
</html>
