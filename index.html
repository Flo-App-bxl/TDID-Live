<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>TDID Live – Brel / Delta / Erasm.</title>
<style>
  :root{--bg:#0f1115;--fg:#eaeef5;--card:#141923;--line:#1e2330;--accent:#1a5bff}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  body{padding-top:64px}
  .top{position:fixed;top:0;left:0;right:0;height:64px;display:flex;gap:8px;align-items:center;padding:10px 12px;background:#12151bde;border-bottom:1px solid var(--line);backdrop-filter:blur(6px);z-index:10}
  .brand{font-weight:700;margin-right:8px}
  .btn{padding:8px 14px;border:1px solid var(--line);border-radius:12px;background:var(--card);color:var(--fg);cursor:pointer}
  .btn.active{background:var(--accent);color:#fff;border-color:transparent}
  .wrap{height:calc(100vh - 64px);display:flex;align-items:center;justify-content:center}
  img{max-width:100%;max-height:100%;object-fit:contain}
  .stamp{margin-left:auto;opacity:.85;font-size:.9em}
  .note{position:fixed;bottom:8px;left:50%;transform:translateX(-50%);opacity:.85;font-size:.85em;text-align:center;white-space:pre-line;max-width:92vw}
</style>
</head>
<body>
  <div class="top">
    <span class="brand">TDID Live</span>
    <button class="btn" id="brel">Brel</button>
    <button class="btn" id="delta">Delta</button>
    <button class="btn" id="erasme">Erasm.</button>
    <span class="stamp" id="stamp">—</span>
  </div>

  <div class="wrap"><img id="view" alt="TDID Live"></div>
  <div class="note" id="note"></div>

<script>
/* ====== CONFIG SP ====== */
const SP_BASE   = "https://stibmivb-my.sharepoint.com/personal/florent_legrain_stib_brussels";
const SP_FOLDER = "/personal/florent_legrain_stib_brussels/Documents/LiveMirror";
function spRaw(file){
  const src = `${SP_FOLDER}/${file}`;
  return `${SP_BASE}/_layouts/15/download.aspx?SourceUrl=${encodeURIComponent(src)}`;
}
const DATA_SP = {
  brel:   { img: spRaw("live_brel.png"),   age: spRaw("live_brel.age.txt")   },
  delta:  { img: spRaw("live_delta.png"),  age: spRaw("live_delta.age.txt")  },
  erasme: { img: spRaw("live_erasme.png"), age: spRaw("live_erasme.age.txt") }
};
const ERR_IMG_SP = spRaw("TDID_Erreur.png");

/* ====== CONFIG MIROIR (GitHub Pages) ====== */
const MIRROR_LATEST = "https://Flo-App-bxl.github.io/TDID-Live/mirror/latest.json";
const MIRROR_KEY = { brel: "brel", delta: "delta", erasme: "eras" };

/* Rafraîchissement & seuil (5 minutes) */
const REFRESH_MS = 3000;      // 3 s
const STALE_MS   = 300000;    // 5 min

/* ====== UI ====== */
const img   = document.getElementById('view');
const stamp = document.getElementById('stamp');
const note  = document.getElementById('note');
const btns  = { brel:document.getElementById('brel'), delta:document.getElementById('delta'), erasme:document.getElementById('erasme') };

let depot = localStorage.getItem('tdid_depot') || 'brel';
let lastOk = 0;
let lastBlobUrl = null;
let lastSource = "—";   // "SP" | "Miroir" | "Erreur"

function setActive(){ for(const k in btns){ btns[k].classList.toggle('active', k===depot); } }
for(const k in btns){ btns[k].onclick = () => { depot=k; localStorage.setItem('tdid_depot', depot); setActive(); tick(true); }; }
setActive();

/* ====== Utils ====== */
const cb = u => u + (u.includes('?')?'&':'?') + 't=' + Date.now();

function setStampSource(srcLabel){
  lastSource = srcLabel;
  const nowTxt = new Date().toLocaleString();
  stamp.textContent = `${srcLabel} • ${nowTxt}`;
}

function normalizeEpoch(raw){
  if (raw == null) return null;
  let s = String(raw).replace(/^\uFEFF/, '').trim();
  if (!/^\d+$/.test(s)) s = s.replace(/[^\d]/g,'');
  if (!s) return null;
  let ms = Number(s);
  if (!Number.isFinite(ms)) return null;
  if (ms < 1e12) ms *= 1000;
  const now = Date.now();
  if (ms - now > 10*60*1000){
    const offsetMin = new Date().getTimezoneOffset();
    ms = ms - offsetMin*60000;
  }
  return ms;
}

/* ====== SharePoint (direct) ====== */
async function readAgeSP(url){
  try{
    const r = await fetch(cb(url), {cache:'no-store', credentials:'include'});
    if(!r.ok) return {ms:null, why:'HTTP '+r.status};
    const raw = await r.text();
    const ms  = normalizeEpoch(raw);
    if (!Number.isFinite(ms)) return {ms:null, why:'parse'};
    return {ms, why:null};
  }catch(e){ return {ms:null, why:'fetch'}; }
}

function showImageSP(src){
  return new Promise(resolve=>{
    img.onload  = ()=>{ lastOk = Date.now(); setStampSource("SP"); resolve(true); };
    img.onerror = ()=>{ setStampSource("SP (image KO)"); resolve(false); };
    img.src = cb(src);
  });
}

/* ====== Miroir (GitHub) ====== */
async function loadMirrorLatest(){
  try{
    const r = await fetch(cb(MIRROR_LATEST), {cache:'no-store'});
    if (!r.ok) return null;
    return await r.json();
  }catch(e){ return null; }
}

async function showImageMirror(url){
  try{
    const r = await fetch(cb(url), {cache:'no-store'});
    if (!r.ok) throw new Error('HTTP '+r.status);
    const blob = await r.blob();
    if (lastBlobUrl) URL.revokeObjectURL(lastBlobUrl);
    const u = URL.createObjectURL(blob);
    lastBlobUrl = u;
    return await new Promise(res=>{
      img.onload  = ()=>{ lastOk = Date.now(); setStampSource("Miroir"); res(true); };
      img.onerror = ()=>{ setStampSource("Miroir (image KO)"); res(false); };
      img.src = u;
    });
  }catch(e){ return false; }
}

/* ====== Boucle principale ====== */
async function tick(force=false){
  const {img:imgUrl, age:ageUrl} = DATA_SP[depot];
  let diag = `Dépôt: ${depot}\n`;

  const a = await readAgeSP(ageUrl);
  if (a.ms !== null){
    // Cas normal : age.txt présent et valide
    const delta = Date.now() - a.ms;
    const dSec  = Math.round(delta/1000);
    const stale = delta >= STALE_MS;
    diag += `SP age OK • Δ=${dSec}s → ${stale ? 'STALE' : 'OK'}`;

    if (stale){
      if (lastBlobUrl){ URL.revokeObjectURL(lastBlobUrl); lastBlobUrl=null; }
      img.src = ERR_IMG_SP;
      setStampSource("Erreur (SP)");
      note.textContent  = diag + "\n→ Erreur (origine : SP en retard ≥ 5 min)";
      return;
    }

    // Image SP récente
    const ok = await showImageSP(imgUrl);
    if (ok){ note.textContent = diag + "\nSP image OK • source: SP"; return; }
    else   { diag += "\nSP image KO → tentative miroir"; }
  } else {
    // age.txt absent ou illisible : on tente l’image SP quand même
    diag += `SP age indisponible (${a.why}) → tentative image directe`;
    const okImg = await showImageSP(imgUrl);
    if (okImg){
      note.textContent = diag + "\n→ SP image OK (sans age.txt) • source: SP";
      return;
    } else {
      diag += "\nSP image KO → fallback miroir";
    }
  }

  // --- Miroir ---
  const m = await loadMirrorLatest();
  if (!m || !m.items){
    note.textContent = diag + "\nmiroir indisponible";
    img.src = ERR_IMG_SP;
    setStampSource("Erreur (miroir indisponible)");
    return;
  }

  const key  = MIRROR_KEY[depot];
  const item = m.items?.[key];
  if (!item || !item.url){
    note.textContent = diag + `\nmiroir: entrée manquante (${key})`;
    img.src = ERR_IMG_SP;
    setStampSource("Erreur (miroir manquant)");
    return;
  }

  const deltaM = Date.now() - (item.ts * 1000);
  const dSecM  = Math.round(deltaM/1000);
  const staleM = deltaM >= STALE_MS;
  diag += `\nMIROIR age • Δ=${dSecM}s → ${staleM ? 'STALE' : 'OK'}`;

  if (staleM){
    img.src = ERR_IMG_SP;
    setStampSource("Erreur (miroir)");
    note.textContent  = diag + "\n→ Erreur (origine : miroir en retard ≥ 5 min)";
    return;
  }

  const okMirror = await showImageMirror(item.url);
  if (!okMirror){
    img.src = ERR_IMG_SP;
    setStampSource("Erreur (miroir KO)");
    note.textContent = diag + "\nmiroir image KO → Erreur (origine : miroir indisponible)";
  } else {
    note.textContent = diag + "\nmiroir image OK • source: Miroir";
  }
}

setInterval(()=>tick(false), REFRESH_MS);
tick(true);
</script>
</body>
</html>