<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>TDID Live – Brel / Delta / Erasm.</title>
<style>
  :root{--bg:#0f1115;--fg:#eaeef5;--card:#141923;--line:#1e2330;--accent:#1a5bff}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  body{padding-top:64px}
  .top{position:fixed;top:0;left:0;right:0;height:64px;display:flex;gap:8px;align-items:center;padding:10px 12px;background:#12151bde;border-bottom:1px solid var(--line);backdrop-filter:blur(6px);z-index:10}
  .brand{font-weight:700;margin-right:8px}
  .btn{padding:8px 14px;border:1px solid var(--line);border-radius:12px;background:var(--card);color:var(--fg);cursor:pointer}
  .btn.active{background:var(--accent);color:#fff;border-color:transparent}
  .wrap{height:calc(100vh - 64px);display:flex;align-items:center;justify-content:center}
  img{max-width:100%;max-height:100%;object-fit:contain}
  .stamp{margin-left:auto;opacity:.85;font-size:.9em}
  .note{position:fixed;bottom:8px;left:50%;transform:translateX(-50%);opacity:.85;font-size:.85em;text-align:center;white-space:pre-line}
  #loginBtn{display:none;position:fixed;top:72px;right:12px;padding:10px 14px;border-radius:10px;border:1px solid var(--line);background:#1a5bff;color:#fff;z-index:20}
</style>
</head>
<body>
  <div class="top">
    <span class="brand">TDID Live</span>
    <button class="btn" id="brel">Brel</button>
    <button class="btn" id="delta">Delta</button>
    <button class="btn" id="erasme">Erasm.</button>
    <span class="stamp" id="stamp">—</span>
  </div>

  <button id="loginBtn">Se connecter au compte STIB</button>

  <div class="wrap"><img id="view" alt="TDID Live"></div>
  <div class="note" id="note"></div>

<script>
/* ====== CONFIG ====== */

/* Page dossier OneDrive (vue Web). IMPORTANT : on redirige vers CETTE page
   en top-level pour poser les cookies d’auth, puis l’utilisateur revient en arrière.
   (C’est ce que Safari/ITP exige pour les cookies cross-site.) */
const SP_SIGNIN_PAGE =
  "https://stibmivb-my.sharepoint.com/personal/florent_legrain_stib_brussels/_layouts/15/onedrive.aspx?id=%2Fpersonal%2Fflorent_legrain_stib_brussels%2FDocuments%2FLiveMirror";

/* Liens fichiers en download direct (anti-cache SharePoint) */
const DATA = {
  brel: {
    img: "https://stibmivb-my.sharepoint.com/_layouts/15/download.aspx?SourceUrl=https%3A%2F%2Fstibmivb-my.sharepoint.com%2Fpersonal%2Fflorent_legrain_stib_brussels%2FDocuments%2FLiveMirror%2Flive_brel.png",
    age: "https://stibmivb-my.sharepoint.com/_layouts/15/download.aspx?SourceUrl=https%3A%2F%2Fstibmivb-my.sharepoint.com%2Fpersonal%2Fflorent_legrain_stib_brussels%2FDocuments%2FLiveMirror%2Flive_brel.age.txt"
  },
  delta: {
    img: "https://stibmivb-my.sharepoint.com/_layouts/15/download.aspx?SourceUrl=https%3A%2F%2Fstibmivb-my.sharepoint.com%2Fpersonal%2Fflorent_legrain_stib_brussels%2FDocuments%2FLiveMirror%2Flive_delta.png",
    age: "https://stibmivb-my.sharepoint.com/_layouts/15/download.aspx?SourceUrl=https%3A%2F%2Fstibmivb-my.sharepoint.com%2Fpersonal%2Fflorent_legrain_stib_brussels%2FDocuments%2FLiveMirror%2Flive_delta.age.txt"
  },
  erasme: {
    img: "https://stibmivb-my.sharepoint.com/_layouts/15/download.aspx?SourceUrl=https%3A%2F%2Fstibmivb-my.sharepoint.com%2Fpersonal%2Fflorent_legrain_stib_brussels%2FDocuments%2FLiveMirror%2Flive_erasme.png",
    age: "https://stibmivb-my.sharepoint.com/_layouts/15/download.aspx?SourceUrl=https%3A%2F%2Fstibmivb-my.sharepoint.com%2Fpersonal%2Fflorent_legrain_stib_brussels%2FDocuments%2FLiveMirror%2Flive_erasme.age.txt"
  }
};
const ERR_IMG = "https://stibmivb-my.sharepoint.com/_layouts/15/download.aspx?SourceUrl=https%3A%2F%2Fstibmivb-my.sharepoint.com%2Fpersonal%2Fflorent_legrain_stib_brussels%2FDocuments%2FLiveMirror%2FTDID_Erreur.png";

const REFRESH_MS = 3000;
const STALE_MS   = 120000;

/* ====== UI ====== */
const img    = document.getElementById('view');
const stamp  = document.getElementById('stamp');
const note   = document.getElementById('note');
const btns   = { brel:document.getElementById('brel'), delta:document.getElementById('delta'), erasme:document.getElementById('erasme') };
const loginBtn = document.getElementById('loginBtn');

let depot = localStorage.getItem('tdid_depot') || 'brel';
let lastOk = 0;
let lastBlobUrl = null;
const cb = u => u + (u.includes('?')?'&':'?') + 't=' + Date.now();

function setActive(){ for (const k in btns) btns[k].classList.toggle('active', k===depot); }
for (const k in btns){ btns[k].onclick = () => { depot=k; localStorage.setItem('tdid_depot', depot); setActive(); tick(true); }; }
setActive();

/* ====== Auth robuste ======
   1) On fait le fetch avec credentials:include
   2) Si status 401/403 -> pas connecté
   3) Si 200 mais Content-Type = text/html (login/MFA), on considère pas connecté
   4) Dans ces cas, on propose un bouton ET on peut forcer la redirection top-level */
async function fetchNoStore(url){
  let r;
  try{
    r = await fetch(url, { cache:'no-store', credentials:'include', redirect:'follow' });
  }catch(e){
    return { ok:false, status:0, headers:new Headers(), text:async()=>"", blob:async()=>new Blob() };
  }
  const ct = (r.headers.get('Content-Type')||"").toLowerCase();
  if (r.status===401 || r.status===403 || ct.startsWith('text/html')){
    showSigninUI();
  }
  return r;
}
function showSigninUI(){
  loginBtn.style.display = 'inline-block';
  // Redirection en top-level pour que les cookies soient acceptés
  loginBtn.onclick = () => { window.location.href = SP_SIGNIN_PAGE; };
  if (!note.textContent.includes('connexion')){
    note.textContent = (note.textContent ? note.textContent + "\n" : "")
      + "Connexion STIB requise : cliquez sur « Se connecter au compte STIB », authentifiez-vous, puis revenez sur cette page.";
  }
}

/* ====== Epoch normalisé ====== */
function normalizeEpoch(raw){
  if (raw == null) return null;
  let s = String(raw).replace(/^\uFEFF/,'').trim().replace(',', '.');
  let n = Number.parseFloat(s);
  if (!Number.isFinite(n)) return null;
  if (n < 1e12) n = Math.round(n*1000); else n = Math.round(n);
  if (n - Date.now() > 600000){ n -= new Date().getTimezoneOffset()*60000; }
  return n;
}

/* ====== age.txt ====== */
async function readAge(url){
  try{
    const r = await fetchNoStore(cb(url));
    if (!r.ok) return {ms:null, why:'HTTP '+r.status};
    const raw = (await r.text()).trim();
    const ms  = normalizeEpoch(raw);
    if (!Number.isFinite(ms)) return {ms:null, why:'parse'};
    return {ms, why:null};
  }catch(e){ return {ms:null, why:'fetch'}; }
}

/* ====== Image ====== */
async function showImage(src){
  const r = await fetchNoStore(cb(src));
  const ct = (r.headers.get('Content-Type')||"").toLowerCase();
  if (!r.ok || ct.startsWith('text/html')){
    stamp.textContent = "Image KO (connexion STIB requise ?) • " + new Date().toLocaleString();
    return false;
  }
  const blob = await r.blob();
  if (lastBlobUrl) URL.revokeObjectURL(lastBlobUrl);
  const url = URL.createObjectURL(blob);
  return new Promise(resolve=>{
    img.onload  = ()=>{ lastOk = Date.now(); stamp.textContent = new Date().toLocaleString(); resolve(true); };
    img.onerror = ()=>{ stamp.textContent = "Image KO • " + new Date().toLocaleString(); resolve(false); };
    lastBlobUrl = url;
    img.src = url;
  });
}

/* ====== Boucle ====== */
async function tick(force=false){
  const {img:imgUrl, age:ageUrl} = DATA[depot];
  let diag = `Depot: ${depot}\n`;

  const info = await readAge(ageUrl);
  if (info.ms !== null){
    const delta = Date.now() - info.ms;
    const dSec  = Math.round(delta/1000);
    diag += `age.txt OK • Δ=${dSec}s → ${dSec>=120 ? 'STALE' : 'OK'}`;
    if (delta >= STALE_MS){
      img.src = ERR_IMG;
      stamp.textContent = "Hors service (≥2 min) • " + new Date().toLocaleString();
      note.textContent = diag + "\n→ Affichage Erreur";
      return;
    }
  } else {
    diag += `age.txt indisponible (${info.why}) • tentative image`;
  }

  const ok = await showImage(imgUrl);
  if (!ok && (force || (lastOk>0 && Date.now()-lastOk>=STALE_MS))){
    img.src = ERR_IMG;
    diag += "\nimage KO → Erreur";
  }
  note.textContent = diag;
}

setInterval(()=>tick(false), REFRESH_MS);
tick(true);
</script>
</body>
</html>
