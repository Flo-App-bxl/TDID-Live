<!doctype html>
<meta charset="utf-8">
<title>TDID Live – Viewer</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  html,body{height:100%;margin:0;background:#0f1115}
  img{display:block;margin:auto;max-width:100%;max-height:100vh;object-fit:contain}
  .bar{position:fixed;top:0;left:0;right:0;height:38px;background:#141923;color:#eaeef5;
       font:14px/38px system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;padding:0 10px}
  .bar small{opacity:.75}
</style>
<div class="bar">TDID Live – <span id="name"></span> <small id="note"></small></div>
<img id="v" alt="live">

<script>
  // Usage: viewer.html?img=live_brel.png&age=live_brel.age.txt
  const p = new URLSearchParams(location.search);
  const img = p.get('img') || 'live_brel.png';
  const age = p.get('age') || 'live_brel.age.txt';
  const ERR = 'TDID_Erreur.png';
  const REFRESH = 3000;          // 3 s
  const STALE = 120000;          // 2 min

  const el = document.getElementById('v');
  const note = document.getElementById('note');
  document.getElementById('name').textContent = img;

  const cb = u => u + (u.includes('?')?'&':'?') + 't=' + Date.now();

  async function ageMs(url){
    try{
      const r = await fetch(cb(url), {cache:'no-store'});
      const t = (await r.text()).trim();
      const ms = parseInt(t, 10);
      return Number.isFinite(ms) ? ms : null;
    }catch{ return null }
  }

  async function tick(){
    const a = await ageMs(age);
    if (a && (Date.now()-a)>=STALE){
      el.src = ERR;
      note.textContent = ' • hors service (≥2 min)';
    }else{
      el.src = cb(img);          // cache-buster
      note.textContent = '';
    }
  }

  tick();
  setInterval(tick, REFRESH);
</script>
